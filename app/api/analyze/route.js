import { NextResponse } from "next/server";
import { db } from "@/lib/firebase";
import { collection, getDocs, doc, updateDoc } from "firebase/firestore";

// üß† ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥ (Levenshtein)
function levenshtein(a, b) {
  const matrix = [];
  for (let i = 0; i <= b.length; i++) matrix[i] = [i];
  for (let j = 0; j <= a.length; j++) matrix[0][j] = j;

  for (let i = 1; i <= b.length; i++) {
    for (let j = 1; j <= a.length; j++) {
      matrix[i][j] =
        b[i - 1] === a[j - 1]
          ? matrix[i - 1][j - 1]
          : Math.min(
              matrix[i - 1][j - 1],
              matrix[i][j - 1],
              matrix[i - 1][j]
            ) + 1;
    }
  }
  return matrix[b.length][a.length];
}

export async function POST(req) {
  try {
    const { userId, baseCategories, transactions } = await req.json();

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö userId
    if (!userId) {
      return NextResponse.json({ error: "‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ userId" }, { status: 400 });
    }

    // ‚úÖ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏°‡∏≤)
    const categoriesFromHome =
      baseCategories && baseCategories.length > 0
        ? baseCategories
        : [
            "‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°",
            "‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ",
            "‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞/‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
            "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤/‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤",
            "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£",
            "‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
            "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå/‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤",
            "‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á",
            "‡∏≠‡∏∑‡πà‡∏ô‡πÜ",
          ];

    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    let expenseTransactions = [];
    if (transactions && transactions.length > 0) {
      expenseTransactions = transactions;
    } else {
      const userTransRef = collection(db, `users/${userId}/transactions`);
      const snapshot = await getDocs(userTransRef);
      if (snapshot.empty) {
        return NextResponse.json({ message: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ" });
      }
      const allTrans = snapshot.docs.map((doc) => doc.data());
      expenseTransactions = allTrans.filter((t) => t.type === "expense");
    }

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏´‡∏°
    if (expenseTransactions.length === 0) {
      return NextResponse.json({ message: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" });
    }

    // ‚úÖ ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
    const categoryHints = {
      "‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞/‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á": [
        // ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏£‡∏ñ
        "‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", "‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", "‡∏õ‡∏ï‡∏ó", "esso", "shell", "caltex", "bangchak", "gas", "fuel", "petrol", "diesel", "benzin", "gasoline",
        // ‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£
        "‡πÅ‡∏ó‡πá‡∏Å‡∏ã‡∏µ‡πà", "‡∏£‡∏ñ‡πÄ‡∏°‡∏•‡πå", "‡∏£‡∏ñ‡πÅ‡∏î‡∏á", "‡∏£‡∏ñ‡∏™‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß", "BTS", "MRT", "skytrain", "‡πÅ‡∏Å‡∏£‡πá‡∏ö", "grab", "bolt", "‡∏£‡∏ñ‡πÑ‡∏ü", "‡∏£‡∏ñ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤", "‡∏£‡∏ñ‡∏ï‡∏π‡πâ", "‡∏°‡∏¥‡∏ô‡∏¥‡∏ö‡∏±‡∏™", "taxi", "uber", "bus", "train", "van",
        // ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏¥‡∏ô
        "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏¥‡∏ô", "‡∏™‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏ô", "‡∏ï‡∏±‡πã‡∏ß‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏¥‡∏ô", "‡∏ï‡∏±‡πã‡∏ß‡∏ö‡∏¥‡∏ô", "airasia", "nok air", "thai airways", "flight", "airline", "airplane",
        // ‡∏à‡∏≠‡∏î‡∏£‡∏ñ
        "‡∏à‡∏≠‡∏î‡∏£‡∏ñ", "‡∏Ñ‡πà‡∏≤‡∏à‡∏≠‡∏î", "‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ", "parking",
        // ‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏ñ
        "‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏ñ", "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏¢‡∏≤‡∏á", "‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞", "‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏ñ", "car wash", "repair",
        // ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", "‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£", "‡∏Ñ‡πà‡∏≤‡∏£‡∏ñ", "transportation", "travel"
      ],
      "‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°": [
        // ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° (‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡πà‡∏≠‡∏ô "‡∏ô‡πâ‡∏≥")
        "‡∏Å‡∏≤‡πÅ‡∏ü", "‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà", "‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ö‡∏±‡∏Ñ‡∏™‡πå", "starbucks", "amazon", "cafe", "coffee", "espresso", "latte", "cappuccino", "americano",
        "‡∏ä‡∏≤", "‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", "‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢", "tea", "milk tea", "green tea",
        "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", "‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°", "‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏î‡∏•‡∏°", "‡πÇ‡∏Ñ‡πâ‡∏Å", "coke", "pepsi", "sprite", "soft drink", "beverage", "juice", "smoothie",
        // ‡∏≠‡∏≤‡∏´‡∏≤‡∏£
        "‡∏Ç‡πâ‡∏≤‡∏ß", "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î", "‡∏Ç‡πâ‡∏≤‡∏ß‡∏£‡∏≤‡∏î‡πÅ‡∏Å‡∏á", "‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô‡πÑ‡∏Å‡πà", "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß", "‡∏ú‡∏±‡∏î‡πÑ‡∏ó‡∏¢", "‡∏™‡πâ‡∏°‡∏ï‡∏≥", "rice", "noodle",
        "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß", "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤", "‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô", "‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á", "food", "meal", "breakfast", "lunch", "dinner", "snack",
        "‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡∏†‡∏±‡∏ï‡∏ï‡∏≤‡∏Ñ‡∏≤‡∏£", "‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡∏ü‡∏π‡πâ‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏ó", "restaurant", "food court", "canteen", "buffet",
        // ‡∏ü‡∏≤‡∏™‡∏ï‡πå‡∏ü‡∏π‡πâ‡∏î
        "‡∏û‡∏¥‡∏ã‡∏ã‡πà‡∏≤", "pizza", "burger", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå", "‡πÅ‡∏°‡∏Ñ‡πÇ‡∏î‡∏ô‡∏±‡∏•‡∏î‡πå", "mcdonald", "kfc", "‡πÄ‡∏Ñ‡πÄ‡∏≠‡∏ü‡∏ã‡∏µ", "subway", "domino",
        "‡πÅ‡∏ã‡∏ô‡∏ß‡∏¥‡∏ä", "‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä", "‡πÄ‡πÄ‡∏ß‡∏ô‡∏ß‡∏¥‡∏ó", "sandwich", "sub",
        // ‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô
        "‡∏Ç‡∏ô‡∏°", "‡πÄ‡∏Ñ‡πâ‡∏Å", "‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°", "‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà", "cake", "ice cream", "dessert", "bakery", "donut", "chocolate",
        // ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
        "‡∏ú‡∏±‡∏Å", "‡∏ú‡∏•‡πÑ‡∏°‡πâ", "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠", "‡∏´‡∏°‡∏π", "‡πÑ‡∏Å‡πà", "‡∏õ‡∏•‡∏≤", "‡πÑ‡∏Ç‡πà", "‡∏ô‡∏°", "‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á", "vegetable", "fruit", "meat", "pork", "chicken", "fish", "egg", "milk", "bread",
        // ‡∏ï‡∏•‡∏≤‡∏î/‡∏ã‡∏π‡πÄ‡∏õ‡∏≠‡∏£‡πå
        "‡∏ï‡∏•‡∏≤‡∏î", "‡πÄ‡∏ã‡πÄ‡∏ß‡πà‡∏ô", "7-11", "big c", "lotus", "tops", "makro", "market", "supermarket", "convenience store",
        // ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        "‡∏ô‡πâ‡∏≥", "drink", "food", "eating"
      ],
      "‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ": [
        // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤
        "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤", "‡πÄ‡∏ä‡πà‡∏≤‡∏ö‡πâ‡∏≤‡∏ô", "‡πÄ‡∏ä‡πà‡∏≤‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î", "‡πÄ‡∏ä‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á", "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤", "rent", "rental",
        "‡∏ö‡πâ‡∏≤‡∏ô", "‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î", "‡∏´‡πâ‡∏≠‡∏á", "‡∏≠‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå", "apartment", "condo", "house", "room",
        // ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü
        "‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü", "‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤", "‡πÑ‡∏ü‡∏ü‡πâ‡∏≤", "electric", "electricity", "‡∏Å‡∏ü‡∏ô", "mea", "pea",
        "‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥", "‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤", "‡∏õ‡∏£‡∏∞‡∏õ‡∏≤", "water", "water bill",
        // ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤
        "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤", "‡πÅ‡∏≠‡∏£‡πå", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏®", "air conditioner", "ac",
        "‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô", "refrigerator", "fridge",
        "‡∏ó‡∏µ‡∏ß‡∏µ", "‡πÇ‡∏ó‡∏£‡∏ó‡∏±‡∏®‡∏ô‡πå", "television", "tv",
        "‡∏û‡∏±‡∏î‡∏•‡∏°", "fan",
        "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤", "washing machine",
        // ‡πÄ‡∏ü‡∏≠‡∏£‡πå‡∏ô‡∏¥‡πÄ‡∏à‡∏≠‡∏£‡πå
        "‡πÄ‡∏ü‡∏≠‡∏£‡πå‡∏ô‡∏¥‡πÄ‡∏à‡∏≠‡∏£‡πå", "‡πÇ‡∏ã‡∏ü‡∏≤", "‡πÄ‡∏ï‡∏µ‡∏¢‡∏á", "‡∏ï‡∏π‡πâ", "‡πÇ‡∏ï‡πä‡∏∞", "‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ", "furniture", "sofa", "bed", "table", "chair", "cabinet",
        // ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô
        "‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ", "‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô", "‡∏ú‡∏á‡∏ã‡∏±‡∏Å‡∏ü‡∏≠‡∏Å", "‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏ô", "‡πÑ‡∏°‡πâ‡∏Å‡∏ß‡∏≤‡∏î", "household", "detergent", "soap"
      ],
      "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤/‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤": [
        "‡πÄ‡∏™‡∏∑‡πâ‡∏≠", "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤", "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∑‡∏î", "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡∏¥‡πâ‡∏ï", "shirt", "t-shirt", "blouse", "top", "clothes", "clothing",
        "‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á", "‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á‡∏¢‡∏µ‡∏ô‡∏™‡πå", "‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á‡∏Ç‡∏≤‡∏™‡∏±‡πâ‡∏ô", "pants", "jeans", "shorts", "trousers",
        "‡∏Å‡∏£‡∏∞‡πÇ‡∏õ‡∏£‡∏á", "‡∏ä‡∏∏‡∏î", "‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏£‡∏™", "skirt", "dress",
        "‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤", "‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏ú‡πâ‡∏≤‡πÉ‡∏ö", "‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÅ‡∏ï‡∏∞", "‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏ö‡∏π‡∏ó", "shoes", "sneakers", "sandals", "boots", "footwear",
        "‡∏ñ‡∏∏‡∏á‡πÄ‡∏ó‡πâ‡∏≤", "socks",
        "‡∏´‡∏°‡∏ß‡∏Å", "‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏õ", "hat", "cap",
        "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤", "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå", "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏õ‡πâ", "bag", "backpack", "wallet", "purse",
        "‡πÄ‡∏Ç‡πá‡∏°‡∏Ç‡∏±‡∏î", "belt",
        "‡πÅ‡∏ß‡πà‡∏ô‡∏ï‡∏≤", "glasses", "sunglasses",
        "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö", "jewelry",
        // ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå
        "uniqlo", "h&m", "zara", "nike", "adidas", "converse", "vans", "crocs", "jaspal", "mc", "lyn"
      ],
      "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£": [
        "‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠", "‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", "‡∏Ñ‡πà‡∏≤‡πÇ‡∏ó‡∏£", "‡∏Ñ‡πà‡∏≤‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", "phone", "mobile", "telephone",
        "‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï", "‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï", "‡πÄ‡∏ô‡πá‡∏ï", "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï", "wifi", "internet", "broadband", "fiber",
        "‡∏ã‡∏¥‡∏°", "‡∏ã‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î", "sim", "sim card",
        "‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô", "top up", "refill",
        "‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à", "package", "data",
        // ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
        "true", "ais", "dtac", "‡∏ó‡∏£‡∏π", "‡πÄ‡∏≠‡πÑ‡∏≠‡πÄ‡∏≠‡∏™", "‡∏î‡∏µ‡πÅ‡∏ó‡∏Ñ", "nt", "3bb", "tot"
      ],
      "‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤": [
        "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏≠‡∏°", "tuition", "school fee", "education",
        "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠", "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏ï‡∏≥‡∏£‡∏≤", "book", "textbook",
        "‡∏ï‡∏¥‡∏ß", "‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏Ñ‡∏≠‡∏£‡πå‡∏™", "‡∏≠‡∏ö‡∏£‡∏°", "‡∏™‡∏≠‡∏ô", "course", "tutorial", "training", "class", "lesson",
        "‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤", "‡∏î‡∏¥‡∏ô‡∏™‡∏≠", "‡∏™‡∏°‡∏∏‡∏î", "‡∏¢‡∏≤‡∏á‡∏•‡∏ö", "‡πÑ‡∏°‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î", "pen", "pencil", "notebook", "eraser", "ruler",
        "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô", "stationery",
        "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢", "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢", "school", "university", "college",
        "‡∏Ñ‡πà‡∏≤‡∏™‡∏≠‡∏ö", "exam", "test"
      ],
      "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå/‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤": [
        "‡∏¢‡∏≤", "‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î", "‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πâ", "‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏´‡∏ß‡∏±‡∏î", "‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏ó‡πâ‡∏≠‡∏á", "medicine", "drug", "pill", "tablet",
        "‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°", "vitamin", "supplement",
        "‡∏´‡∏°‡∏≠", "‡πÅ‡∏û‡∏ó‡∏¢‡πå", "‡∏ô‡∏û", "doctor", "physician",
        "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•", "‡∏£‡∏û", "hospital",
        "‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å", "clinic",
        "‡∏£‡∏±‡∏Å‡∏©‡∏≤", "‡∏ï‡∏£‡∏ß‡∏à", "‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤", "‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏£‡∏Ñ", "treatment", "checkup", "check up",
        "‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•", "nurse",
        "‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå", "‡∏´‡∏°‡∏≠‡∏ü‡∏±‡∏ô", "‡∏ü‡∏±‡∏ô", "dentist", "dental",
        "‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏¢‡∏≤", "‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤", "pharmacy", "drug store",
        "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô", "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û", "insurance", "health insurance"
      ],
      "‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á": [
        "‡∏´‡∏ô‡∏±‡∏á", "‡∏î‡∏π‡∏´‡∏ô‡∏±‡∏á", "‡πÇ‡∏£‡∏á‡∏´‡∏ô‡∏±‡∏á", "‡∏ã‡∏µ‡πÄ‡∏ô‡∏û‡πÄ‡∏•‡∏Å‡∏ã‡πå", "‡πÄ‡∏°‡πÄ‡∏à‡∏≠‡∏£‡πå", "movie", "cinema", "sf", "major", "cgv",
        "‡πÄ‡∏Å‡∏°", "‡πÄ‡∏Å‡∏°‡∏™‡πå", "‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°", "game", "gaming", "steam", "playstation", "xbox", "nintendo", "garena",
        "‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï", "‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡∏®‡∏Å‡∏≤‡∏•", "concert", "festival", "event",
        "‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", "‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á", "party", "celebration",
        "‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß", "‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß", "‡∏ó‡∏£‡∏¥‡∏õ", "‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏∞‡πÄ‡∏•", "‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏†‡∏π‡πÄ‡∏Ç‡∏≤", "travel", "trip", "tour", "vacation", "holiday",
        "‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç", "‡∏Ç‡∏≠‡∏á‡∏Å‡∏≥‡∏ô‡∏±‡∏•", "gift", "present",
        "‡∏ú‡∏±‡∏ö", "‡∏ö‡∏≤‡∏£‡πå", "‡πÑ‡∏ô‡∏ó‡πå‡∏Ñ‡∏•‡∏±‡∏ö", "pub", "bar", "club", "nightclub",
        "‡∏™‡∏ß‡∏ô‡∏™‡∏ô‡∏∏‡∏Å", "‡∏™‡∏ß‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå", "‡∏û‡∏¥‡∏û‡∏¥‡∏ò‡∏†‡∏±‡∏ì‡∏ë‡πå", "amusement park", "zoo", "museum",
        "‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞", "karaoke",
        "‡∏ô‡∏ß‡∏î", "‡∏™‡∏õ‡∏≤", "massage", "spa",
        "‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™", "‡∏¢‡∏¥‡∏°", "gym", "fitness",
        // Streaming
        "netflix", "spotify", "youtube premium", "disney+", "hbo", "prime video", "apple music"
      ],
      "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": [
        "‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ", "‡∏ó‡∏≥‡∏ö‡∏∏‡∏ç", "‡πÉ‡∏™‡πà‡∏ö‡∏≤‡∏ï‡∏£", "donate", "donation", "charity",
        "‡∏Ç‡∏≠‡∏á‡∏ù‡∏≤‡∏Å", "‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏•‡∏∂‡∏Å", "souvenir",
        "‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡∏ò‡∏µ", "‡∏á‡∏≤‡∏ô‡∏ö‡∏ß‡∏ä", "‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á", "‡∏á‡∏≤‡∏ô‡∏®‡∏û", "ceremony", "wedding", "funeral",
        "‡∏ã‡πà‡∏≠‡∏°‡∏Ç‡∏≠‡∏á", "‡∏ã‡πà‡∏≠‡∏°", "repair", "fix",
        "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ", "other", "misc", "miscellaneous"
      ]
    };

    // ‚úÖ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° object ‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
    const categoryTotals = Object.fromEntries(categoriesFromHome.map((c) => [c, 0]));

    // üß© ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏´‡∏°‡∏ß‡∏î (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô)
    const classifyExpense = (title = "") => {
      const lower = title.toLowerCase().trim();
      let best = "‡∏≠‡∏∑‡πà‡∏ô‡πÜ";
      let minDist = Infinity;

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ "‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô") ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏´‡∏°‡∏ß‡∏î‡∏≠‡∏∑‡πà‡∏ô
      const orderedHints = [
        ["‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞/‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", categoryHints["‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞/‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á"]],
        ["‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", categoryHints["‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°"]],
        ["‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ", categoryHints["‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ"]],
        ["‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤/‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤", categoryHints["‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤/‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤"]],
        ["‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£", categoryHints["‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£"]],
        ["‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤", categoryHints["‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤"]],
        ["‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå/‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤", categoryHints["‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå/‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤"]],
        ["‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á", categoryHints["‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á"]],
        ["‡∏≠‡∏∑‡πà‡∏ô‡πÜ", categoryHints["‡∏≠‡∏∑‡πà‡∏ô‡πÜ"]],
      ];

      // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ö‡∏ö exact match ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß‡πÑ‡∏õ‡∏™‡∏±‡πâ‡∏ô)
      for (const [cat, words] of orderedHints) {
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡∏à‡∏≤‡∏Å‡∏¢‡∏≤‡∏ß‡πÑ‡∏õ‡∏™‡∏±‡πâ‡∏ô
        const sortedWords = [...words].sort((a, b) => b.length - a.length);
        for (const kw of sortedWords) {
          if (lower.includes(kw.toLowerCase())) {
            return cat;
          }
        }
      }

      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ exact match ‡πÉ‡∏ä‡πâ Levenshtein distance
      for (const [cat, words] of orderedHints) {
        for (const kw of words) {
          const dist = levenshtein(lower, kw.toLowerCase());
          if (dist < minDist && dist <= 3) {
            minDist = dist;
            best = cat;
          }
        }
      }
      
      return best;
    };

    // ‚úÖ ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Firestore
    const updatePromises = []; // ‡πÄ‡∏Å‡πá‡∏ö promises ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
    const classifiedItems = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡πÅ‡∏•‡πâ‡∏ß
    
    for (const t of expenseTransactions) {
      const category = classifyExpense(t.title || t.name || "");
      if (categoryTotals[category] !== undefined) {
        categoryTotals[category] += Number(t.amount) || 0;
      }
      
      // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
      classifiedItems.push({
        name: t.title || t.name || "",
        amount: Number(t.amount) || 0,
        category: category,
        date: t.date
      });
      
      // ü§ñ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Firestore (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ id)
      if (t.id && (!t.category || t.category === "‡∏≠‡∏∑‡πà‡∏ô‡πÜ" || t.category === "")) {
        const docRef = doc(db, "transactions", t.id);
        updatePromises.push(
          updateDoc(docRef, { category }).catch(err => {
            console.warn(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${t.id}:`, err.message);
          })
        );
      }
    }
    
    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à
    if (updatePromises.length > 0) {
      await Promise.all(updatePromises);
      console.log(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${updatePromises.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
    }

    // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö
    const categories = categoriesFromHome.map((name) => ({
      name,
      total: categoryTotals[name],
    }));

    // üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å
    const totalExpense = categories.reduce((sum, c) => sum + c.total, 0);
    
    // ‡∏´‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
    const topCategories = [...categories]
      .filter(c => c.total > 0)
      .sort((a, b) => b.total - a.total)
      .slice(0, 3);

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå
    const categoriesWithPercent = categories.map(c => ({
      ...c,
      percent: totalExpense > 0 ? Math.round((c.total / totalExpense) * 100) : 0
    }));

    // üí° ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
    let advice = "";
    
    if (totalExpense === 0) {
      advice = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞ üìä";
    } else if (topCategories.length > 0) {
      const top1 = topCategories[0];
      const top1Percent = totalExpense > 0 ? Math.round((top1.total / totalExpense) * 100) : 0;
      const amountText = top1.total.toLocaleString();

      if (top1Percent >= 50) {
        const baseMessage = `‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î "${top1.name}" ‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏£‡∏ß‡∏° ${amountText} ‡∏ö‡∏≤‡∏ó) ‡πÅ‡∏•‡∏∞‡∏Å‡∏¥‡∏ô‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î`;
        switch (top1.name) {
          case "‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°":
            advice = `üçú ${baseMessage} ‡∏•‡∏≠‡∏á‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡∏ó‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ`;
            break;
          case "‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ":
            advice = `ÔøΩ ${baseMessage} ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ö‡∏≤‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏†‡∏≤‡∏£‡∏∞‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ`;
            break;
          case "‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞/‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á":
            advice = `üöó ${baseMessage} ‡∏•‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏ñ‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á`;
            break;
          case "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤/‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤":
            advice = `üëó ${baseMessage} ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏£‡∏≠‡∏ä‡πà‡∏ß‡∏á‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ`;
            break;
          case "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£":
            advice = `ÔøΩ ${baseMessage} ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î`;
            break;
          case "‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤":
            advice = `üéì ${baseMessage} ‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡∏ß‡πà‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏´‡πâ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏Å‡πà‡∏≠‡∏ô`;
            break;
          case "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå/‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤":
            advice = `üíä ${baseMessage} ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà`;
            break;
          case "‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á":
            advice = `üéâ ${baseMessage} ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏á‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ü‡∏£‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å/‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢`;
            break;
          default:
            advice = `üìâ ${baseMessage} ‡∏•‡∏≠‡∏á‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ö‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏ß‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ`;
            break;
        }
      } else {
        const ranking = topCategories
          .map((c, i) => `${i + 1}. ${c.name} (${c.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó)`)
          .join(", ");

        advice = `üìä ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalExpense.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡πÇ‡∏î‡∏¢‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠: ${ranking}. `;

        if (topCategories.length >= 2 && topCategories[0].total > topCategories[1].total * 2) {
          advice += `‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô "${topCategories[0].name}" ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏≠‡∏∑‡πà‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤ ‡∏•‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏î‡∏•‡∏á‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á`;
        } else {
          advice += `‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏¢‡∏±‡∏á‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏°‡∏î‡∏∏‡∏• ‡πÅ‡∏ï‡πà‡∏•‡∏≠‡∏á‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏î‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î`;
        }
      }
    }

    // ‚úÖ ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    return NextResponse.json({ 
      data: { 
        categories, 
        categoriesWithPercent,
        classifiedItems, // ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡πÅ‡∏•‡πâ‡∏ß
        advice,
        summary: {
          totalExpense,
          topCategory: topCategories[0] || null,
          categoryCount: categories.filter(c => c.total > 0).length,
          transactionCount: expenseTransactions.length
        }
      } 
    }, { status: 200 });
  } catch (error) {
    console.error("‚ùå Error:", error);
    return NextResponse.json(
      {
        error: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
        details: error.message,
      },
      { status: 500 }
    );
  }
}